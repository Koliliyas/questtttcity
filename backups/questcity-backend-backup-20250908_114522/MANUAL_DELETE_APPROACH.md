# –†—É—á–Ω–æ–π –ø–æ–¥—Ö–æ–¥ –∫ —É–¥–∞–ª–µ–Ω–∏—é –∫–≤–µ—Å—Ç–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç —Å ID 48 –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
ForeignKeyViolationError: update or delete on table "quest" violates foreign key constraint "fk_point_quest_id_quest" on table "point"
```

## –†–µ—à–µ–Ω–∏–µ: –†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

–í–º–µ—Å—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **—Ä—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** –≤ –∫–æ–¥–µ.

### üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
async def delete_quest(self, quest_id: int) -> Err[QuestNotFoundException] | Ok[int]:
    """–£–¥–∞–ª–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ –ø–æ ID."""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–≤–µ—Å—Ç–∞
        quest = await self._quest_repository.get_by_oid(quest_id)
        if not quest:
            return Err(QuestNotFoundException())
        
        # 1. –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ (points)
        print(f"Deleting points for quest {quest_id}...")
        points_query = text("DELETE FROM point WHERE quest_id = :quest_id")
        await self._quest_repository._session.execute(points_query, {"quest_id": quest_id})
        
        # 2. –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–π –º–µ—Ä—á (merch)
        print(f"Deleting merch for quest {quest_id}...")
        merch_query = text("DELETE FROM merch WHERE quest_id = :quest_id")
        await self._quest_repository._session.execute(merch_query, {"quest_id": quest_id})
        
        # 3. –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (reviews)
        print(f"Deleting reviews for quest {quest_id}...")
        reviews_query = text("DELETE FROM review WHERE quest_id = :quest_id")
        await self._quest_repository._session.execute(reviews_query, {"quest_id": quest_id})
        
        # 4. –¢–µ–ø–µ—Ä—å —É–¥–∞–ª—è–µ–º —Å–∞–º –∫–≤–µ—Å—Ç
        print(f"Deleting quest {quest_id}...")
        await self._quest_repository.delete(quest)
        
        print(f"Quest {quest_id} and all related data deleted successfully!")
        return Ok(quest_id)
        
    except Exception as e:
        print(f"ERROR: Failed to delete quest {quest_id}: {e}")
        return Err(QuestNotFoundException())
```

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
2. **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** - –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏–ª–∏ –ª–æ–≥–∏–∫—É —É–¥–∞–ª–µ–Ω–∏—è
3. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∏–¥–Ω–æ –∫–∞–∂–¥—ã–π —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è
4. **–õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
5. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)

### üìã –ü–æ—Ä—è–¥–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è

1. **Points** (—Ç–æ—á–∫–∏ –∫–≤–µ—Å—Ç–∞) - –¥–æ—á–µ—Ä–Ω–∏–µ –∑–∞–ø–∏—Å–∏
2. **Merch** (–º–µ—Ä—á) - –¥–æ—á–µ—Ä–Ω–∏–µ –∑–∞–ø–∏—Å–∏  
3. **Reviews** (–æ—Ç–∑—ã–≤—ã) - –¥–æ—á–µ—Ä–Ω–∏–µ –∑–∞–ø–∏—Å–∏
4. **Quest** (–∫–≤–µ—Å—Ç) - —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–ø–∏—Å—å

### üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–∞–∂–¥—ã–π —à–∞–≥ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:
```
Deleting points for quest 48...
Deleting merch for quest 48...
Deleting reviews for quest 48...
Deleting quest 48...
Quest 48 and all related data deleted successfully!
```

### üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ - –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/core/quest/services.py`** - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ delete_quest
2. **`backups/questcity-backup-20250818_153048/src/core/quest/services.py`** - backup
3. **`backups/questcity-backup-20250818_152822/src/core/quest/services.py`** - backup

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_manual_delete.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
- ‚úÖ API endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 (Unauthorized) –≤–º–µ—Å—Ç–æ 500 (Server Error)
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ö–≤–µ—Å—Ç—ã –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
- ‚úÖ –°–≤—è–∑–∞–Ω–Ω—ã–π –º–µ—Ä—á —É–¥–∞–ª—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
- ‚úÖ –°–≤—è–∑–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã —É–¥–∞–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!** üéâ

















