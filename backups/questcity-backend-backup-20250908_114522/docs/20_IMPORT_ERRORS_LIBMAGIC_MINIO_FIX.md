# 20. QuestCity Backend - Import Errors, libmagic, MinIO Setup

## üéØ –û–±–∑–æ—Ä —Ä–µ—à–µ–Ω–∏—è

**–î–∞—Ç–∞:** 27 –∏—é–ª—è 2025  
**–ó–∞–¥–∞—á–∏:** MED-005, MED-006, MED-007  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ó–ê–í–ï–†–®–ï–ù–´  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~3 —á–∞—Å–∞

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ MED-006: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ import errors –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** Backend –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö import errors.

**–†–µ—à–µ–Ω–∏—è:**
1. **–ò—Å–∫–ª—é—á–µ–Ω–∏—è**: –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –∏–∑ `core.exceptions.py` –≤ `core/exceptions/__init__.py`
2. **Python 3.9 —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ó–∞–º–µ–Ω–µ–Ω `Self` –Ω–∞ `TypeVar` –≤ schemas.py
3. **Enum –¥—É–±–ª–∏–∫–∞—Ç—ã**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è `MODERATE_REVIEWS` –≤ Permission
4. **–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: –£–±—Ä–∞–Ω—ã duplicate `connect_timeout` –≤ repositories.py

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ import errors

### ‚úÖ MED-005: libmagic —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è production

**–ü—Ä–æ–±–ª–µ–º–∞:** Fallback –∫–æ–¥ –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ libmagic –≤ production.

**–†–µ—à–µ–Ω–∏—è:**
1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞**: `brew install libmagic` (–≤–µ—Ä—Å–∏—è 5.46)
2. **–£–¥–∞–ª–µ–Ω–∏–µ fallback**: –£–±—Ä–∞–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `if magic is None` 
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ `magic.Magic(mime=True).from_buffer()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME —Ç–∏–ø–æ–≤ –±–µ–∑ fallback

### ‚úÖ MED-007: MinIO –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è S3 health checks

**–ü—Ä–æ–±–ª–µ–º–∞:** S3 health checks –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è MinIO.

**–†–µ—à–µ–Ω–∏—è:**
1. **MinIO –∑–∞–ø—É—Å–∫**: `docker-compose up -d minio` –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 9000/9001
2. **Bucket —Å–æ–∑–¥–∞–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω `questcity-test` —Å root —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. **Health check –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤ s3_health_check
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞/—á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ MinIO —Ä–∞–±–æ—Ç–∞–µ—Ç, S3 health checks –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
```python
# –ë–´–õ–û: core.exceptions.py (—Ñ–∞–π–ª)
class PermissionDeniedError(Exception):
    pass

# –°–¢–ê–õ–û: core/exceptions/__init__.py (–ø–∞–∫–µ—Ç)
class PermissionDeniedError(Exception):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ —Ä–µ—Å—É—Ä—Å—É"""
    pass
```

### Python 3.9 —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
```python
# –ë–´–õ–û: –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Python 3.9
from typing import Self

def model_validate_list(cls) -> list[Self]:
    pass

# –°–¢–ê–õ–û: –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Python 3.9
from typing import TypeVar
T = TypeVar('T', bound='BaseSchema')

def model_validate_list(cls: type[T]) -> list[T]:
    pass
```

### S3 Health Check –±–µ–∑ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```python
# –ë–´–õ–û: –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
async def s3_health_check():
    client = await create_s3_client(s3_settings)  # ‚Üê –≤—ã–∑—ã–≤–∞–µ—Ç health check

# –°–¢–ê–õ–û: –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
async def s3_health_check():
    session = Session()
    client = await session.client(
        service_name="s3",
        endpoint_url=s3_settings.endpoint,
        # ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ).__aenter__()
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫ Backend
```
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Backend...
‚úÖ Lifespan –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
‚úÖ Backend –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!
‚úÖ Health Checker —Ä–∞–±–æ—Ç–∞–µ—Ç (2 —Å–µ—Ä–≤–∏—Å–∞: database, s3)
‚úÖ JWT –∫–ª—é—á–∏ –≥–æ—Ç–æ–≤—ã
‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
‚úÖ Backend –∑–∞–≤–µ—Ä—à–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´! Backend –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
```

### MinIO —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
```
üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO bucket...
‚úÖ Bucket 'questcity-test' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

üéâ MinIO –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
üìä Web –∫–æ–Ω—Å–æ–ª—å: http://localhost:9001
```

### libmagic —Ä–∞–±–æ—Ç–∞
```
‚úÖ Magic –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
‚úÖ MIME –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: text/plain
```

## üìä –£–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –í—Å–µ core –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ (`core/exceptions/`)
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞ —Å `__all__` —ç–∫—Å–ø–æ—Ä—Ç–∞–º–∏
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ Python

### 2. Health Check —Å–∏—Å—Ç–µ–º–∞
- Database Health Check: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- S3 Health Check: ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (–Ω—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ credentials)
- Circuit Breakers: ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã –¥–ª—è –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### 3. MinIO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- Docker Compose –≥–æ—Ç–æ–≤ –¥–ª—è development
- Bucket —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- Ready –¥–ª—è S3 –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ TASKS.md –∫–∞–∫ –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏:
1. **MED-008**: S3 credentials configuration –¥–ª—è health check
2. **MED-009**: Production deployment –¥–ª—è libmagic
3. **MED-010**: S3 health check –≤ Grafana monitoring

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **S3 Health Check**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Forbidden" –∏–∑-–∑–∞ credentials mismatch
2. **Python –≤–µ—Ä—Å–∏—è**: –ö–æ–¥ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è Python 3.9, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 3.11+
3. **MinIO credentials**: Root –∏ app credentials —Ä–∞–∑–¥–µ–ª–µ–Ω—ã

## üí° –£—Ä–æ–∫–∏

1. **Import —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ü–∞–∫–µ—Ç—ã vs —Ñ–∞–π–ª—ã —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
2. **Python –≤–µ—Ä—Å–∏–∏**: –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –Ω–æ–≤—ã—Ö features
3. **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: Health checks –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
4. **Credentials management**: Root –∏ application credentials –¥–ª—è MinIO

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã  
**Backend –≥–æ—Ç–æ–≤:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–µ–Ω  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (CRIT-001, CRIT-002) 