#!/bin/bash

# QuestCity Backend - Background Development Startup
# Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ

set -e

cd "$(dirname "$0")/.."

echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº QuestCity Backend Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ..."

# ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹
echo "ğŸ”„ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²..."
pkill -f "uvicorn app:create_app" 2>/dev/null || true

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ‘Ğ”
docker-compose up -d database
sleep 3

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€ Ğ² Ñ„Ğ¾Ğ½Ğµ
echo "ğŸŒ Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ² Ñ„Ğ¾Ğ½Ğµ..."
nohup PYTHONPATH=src poetry run uvicorn app:create_app --factory --host 0.0.0.0 --port 8000 > logs/server.log 2>&1 &

SERVER_PID=$!
echo "âœ… Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ñ PID: $SERVER_PID"
echo "ğŸ“Š Ğ›Ğ¾Ğ³Ğ¸: tail -f logs/server.log"
echo "ğŸŒ API: http://localhost:8000/api/docs"
echo "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°: kill $SERVER_PID"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ PID Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ°
echo $SERVER_PID > .server_pid 