# QuestCity Backend - –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º —Å graceful degradation –∏ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏.

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ #8: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∏ MinIO

- ‚úÖ **Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã** —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- ‚úÖ **Circuit Breaker pattern** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—Ç–∫–∞–∑–æ–≤  
- ‚úÖ **Health Check —Å–∏—Å—Ç–µ–º–∞** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ **Connection pooling** –¥–ª—è PostgreSQL
- ‚úÖ **Graceful degradation** –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ **Health API** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ Kubernetes probes

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã (`core/resilience/retry.py`)

```python
from core.resilience import retry_with_backoff, RetryConfig

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
@retry_with_backoff(RetryConfig(max_attempts=5))
async def my_function():
    # –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å —Å —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–æ–π
    pass

# –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
await retry_database_operation(my_db_func)
await retry_s3_operation(my_s3_func)
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å jitter
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è retry
- Timeout –∑–∞—â–∏—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

### 2. Circuit Breaker (`core/resilience/circuit_breaker.py`)

```python
from core.resilience import circuit_breaker, CircuitBreakerConfig

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—Ç–∫–∞–∑–æ–≤
@circuit_breaker("database", CircuitBreakerConfig(failure_threshold=3))
async def database_operation():
    # –æ–ø–µ—Ä–∞—Ü–∏—è —Å –ë–î
    pass
```

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- **CLOSED** - –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- **OPEN** - –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –æ—à–∏–±–æ–∫
- **HALF_OPEN** - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞

### 3. Health Check —Å–∏—Å—Ç–µ–º–∞ (`core/resilience/health_check.py`)

```python
from core.resilience.health_check import get_health_checker

health_checker = get_health_checker()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞
if health_checker.is_service_available("database"):
    # —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω
    pass

# –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
metrics = health_checker.get_service_metrics("database")
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- Periodic –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Circuit Breaker
- Graceful degradation

### 4. –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

#### PostgreSQL (`db/engine.py`, `db/dependencies.py`)
- Connection pooling (20 connections + 30 overflow)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- Circuit breaker –∑–∞—â–∏—Ç–∞
- Health check –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### MinIO/S3 (`core/repositories.py`)
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è S3 –æ–ø–µ—Ä–∞—Ü–∏–π
- Circuit breaker –¥–ª—è S3 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- Health check –¥–ª—è bucket –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- Graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ S3

### 5. Health API (`api/health.py`)

#### –û—Å–Ω–æ–≤–Ω—ã–µ endpoints:

```bash
# –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å (–¥–ª—è load balancer)
GET /api/v1/health/

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
GET /api/v1/health/detailed

# Kubernetes probes
GET /api/v1/health/live      # Liveness probe
GET /api/v1/health/ready     # Readiness probe

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
GET /api/v1/health/services/database
GET /api/v1/health/services/s3

# –†—É—á–Ω–æ–π —Å–±—Ä–æ—Å Circuit Breaker
POST /api/v1/health/services/database/reset
```

#### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:

```json
{
  "status": "healthy",
  "timestamp": 1705312345.123,
  "services": {
    "total": 2,
    "healthy": 2,
    "degraded": 0,
    "unhealthy": 0
  },
  "message": "All systems operational"
}
```

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`app.py`):

1. ‚úÖ JWT –∫–ª—é—á–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è/—Å–æ–∑–¥–∞—é—Ç—Å—è
2. ‚úÖ Health Checker –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
3. ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ health checks (–ë–î, S3)
4. ‚úÖ Circuit Breaker'—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è
5. ‚úÖ –ü—Ä–∏ shutdown - graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### Health Check –º–µ—Ç—Ä–∏–∫–∏
- –û–±—â–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤ (%)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫

### Circuit Breaker –º–µ—Ç—Ä–∏–∫–∏
- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤
- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—à–∏–±–æ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏–π

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í—Å–µ retry –ø–æ–ø—ã—Ç–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π Circuit Breaker
- Health check —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### PostgreSQL connection pooling
```python
# db/engine.py
pool_size=20              # –ë–∞–∑–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
max_overflow=30           # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ  
pool_timeout=30           # Timeout –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ –ø—É–ª–∞
pool_recycle=3600         # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–∂–¥—ã–π —á–∞—Å
pool_pre_ping=True        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
```

### Retry –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
# –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ
DATABASE_RETRY_CONFIG = RetryConfig(
    max_attempts=3,
    base_delay=0.5,
    max_delay=10.0,
    timeout=30.0
)

S3_RETRY_CONFIG = RetryConfig(
    max_attempts=5,
    base_delay=1.0, 
    max_delay=30.0,
    timeout=60.0
)
```

### Circuit Breaker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```python
DATABASE_CIRCUIT_BREAKER_CONFIG = CircuitBreakerConfig(
    failure_threshold=3,      # –û—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
    recovery_timeout=30.0,    # –í—Ä–µ–º—è –¥–æ –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    success_threshold=2,      # –£—Å–ø–µ—Ö–æ–≤ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    timeout=10.0             # Timeout –æ–ø–µ—Ä–∞—Ü–∏–π
)
```

## üîÑ Graceful Degradation

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏:

1. **–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞**
   - –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏
   - Read-only –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è HTTP 503 –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö endpoints

2. **S3/MinIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**
   - –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - Graceful fallback –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

3. **–ß–∞—Å—Ç–∏—á–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è**
   - –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
   - Health status: "degraded"
   - –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è

## üö® –ê–ª–µ—Ä—Ç—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∞–ª–µ—Ä—Ç—ã:
- Circuit Breaker –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ OPEN > 5 –º–∏–Ω—É—Ç
- Health check failure rate > 50%
- Database connection pool exhaustion
- S3 –æ–ø–µ—Ä–∞—Ü–∏–∏ fail rate > 30%

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º:
- Health endpoints –¥–ª—è Prometheus scraping
- Structured logging –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- Metrics API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

## üìã Checklist –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

- [ ] –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Circuit Breaker
- [ ] –°–æ–∑–¥–∞—Ç—å health check —Ñ—É–Ω–∫—Ü–∏—é
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ Health Checker
- [ ] –î–æ–±–∞–≤–∏—Ç—å graceful degradation –ª–æ–≥–∏–∫—É
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–∞–ª–µ—Ä—Ç—ã

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `core/resilience/` - –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `db/engine.py` - PostgreSQL pooling
- `db/dependencies.py` - –ë–î resilience
- `core/repositories.py` - S3 resilience  
- `api/health.py` - Health API
- `app.py` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: 15 —è–Ω–≤–∞—Ä—è 2025*  
*–°—Ç–∞—Ç—É—Å: ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ #8 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞* 